/*
 *             Copyright (c) 2016 - 2020, CKSource - Frederico Knabben. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';import _0xe26acb from'uuid';import _0x1e9dd0 from'@ckeditor/ckeditor5-utils/src/mix';import EmitterMixin from'@ckeditor/ckeditor5-utils/src/emittermixin';import _0xf2c8a3 from'./../messagescompressor';import _0x1de573 from'./../sessions/sessions';import CollaborativeEditingConnectMessage from'./messages/collaborativeeditingconnectmessage';import CollaborativeEditingUpdateMessage from'./messages/collaborativeeditingupdatemessage';import CollaborativeEditingReconnectMessage from'./messages/collaborativeeditingreconnectmessage';import CollaborativeEditingResponse from'./responses/collaborativeeditingresponse';import CollaborativeEditingConnectResponse from'./responses/collaborativeeditingconnectresponse';import WebSocketGateway from'./../websocketgateway/websocketgateway';import CKEditorCloudServicesError from'../ckeditorcloudserviceserror';export const _SERVICE=0x1;class CollaborativeEditingService{constructor(_0x2c3ed0,_0x283112){if(!_0x2c3ed0)throw new TypeError('Param\x20\x22bundleVersion\x22\x20must\x20be\x20provided.');this['_id']=_0x283112||_0xe26acb['v4'](),this['_isConnected']=!0x1,this['_bundleVersion']=_0x2c3ed0,this['_wsGateway']=void 0x0,this['_channel']=void 0x0;}['getId'](){return this['_id'];}['isConnected'](){return this['_isConnected'];}['connect'](wsGateway,data={}){const _0x115d93=new CollaborativeEditingConnectMessage(this['getId'](),data['buffers'],data['types'],this['_bundleVersion']);return this['_connect'](wsGateway,_0x115d93);}['reconnect'](wsGateway,lastKnowVersion){if(this['isConnected']())throw new CKEditorCloudServicesError('Cannot\x20reconnect\x20to\x20already\x20connected\x20service.',wsGateway);return this['_connect'](wsGateway,new CollaborativeEditingReconnectMessage(this['getId'](),lastKnowVersion,this['_bundleVersion']));}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['sendOperations'](data,_0x557af6){if(!data||!data['types']||!data['types']['length'])return Promise['reject'](new CKEditorCloudServicesError('Cannot\x20send\x20empty\x20update.',this['_wsGateway']));const _0x258df7=parseInt(_0x557af6);if(!Number['isInteger'](_0x258df7)||_0x258df7<0x0)return Promise['reject'](new CKEditorCloudServicesError('Base\x20version\x20not\x20provided.',this['_wsGateway']));const _0x3f61ba=new CollaborativeEditingUpdateMessage(this['getId'](),data['buffers'],data['types'],_0x557af6),_0x4a1526=await this['_wsGateway']['_sendRequest'](0x1,CollaborativeEditingUpdateMessage['TYPE'],_0xf2c8a3['encode'](_0x3f61ba));return _0xf2c8a3['decode'](_0x4a1526,CollaborativeEditingResponse);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new CKEditorCloudServicesError('Collaborative\x20Editing\x20Service\x20is\x20not\x20connected.',this);return this['_connectedSessions']||(this['_connectedSessions']=await _0x1de573['getConnectedSessions'](this['_wsGateway'],this['_id'],0x1)),this['_connectedSessions'];}async['_connect'](wsGateway,_0x46c3db){if(this['isConnected']())return Promise['resolve']();if(wsGateway['state']!==WebSocketGateway['STATE_CONNECTED'])throw new CKEditorCloudServicesError('Web\x20socket\x20gateway\x20is\x20not\x20connected.',wsGateway);this['_wsGateway']=wsGateway,this['stopListening'](wsGateway,'change:state');const _0x16631b=await wsGateway['_sendRequest'](0x1,_0x46c3db['constructor']['TYPE'],_0xf2c8a3['encode'](_0x46c3db)),collaborativeEditingConnectResponse=_0xf2c8a3['decode'](_0x16631b,CollaborativeEditingConnectResponse);return this['listenTo'](wsGateway,'change:state',(..._0x2afe56)=>this['_onWsGatewayStateChange'](..._0x2afe56),{'priority':WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](wsGateway,collaborativeEditingConnectResponse['channel']),this['_isConnected']=!0x0,this['fire']('connected'),collaborativeEditingConnectResponse;}['_connectToChannel'](wsGateway,_0x237a28){this['_channel']=wsGateway['_getChannel'](CollaborativeEditingService['_SERVICE'],_0x237a28),this['listenTo'](this['_channel'],this['_channel']['getEventName'](CollaborativeEditingUpdateMessage['TYPE']),(event,data)=>{const updateMessage=_0xf2c8a3['decode'](data,CollaborativeEditingUpdateMessage);this['fire']('operationsReceived',updateMessage['baseVersion'],updateMessage['data'],updateMessage['metadata']);});}['_onWsGatewayStateChange'](event,property,_0x476a22){_0x476a22===WebSocketGateway['STATE_DISCONNECTED']&&this['disconnect']();}static async['getConnectedSessions'](wsGateway,_0x1b975d){return _0x1de573['getConnectedSessions'](wsGateway,_0x1b975d,0x1);}static get['_SERVICE'](){return 0x1;}}_0x1e9dd0(CollaborativeEditingService,EmitterMixin);export default CollaborativeEditingService;