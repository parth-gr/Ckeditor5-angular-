/*
 *             Copyright (c) 2016 - 2020, CKSource - Frederico Knabben. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';import _0x2e19bb from'@ckeditor/ckeditor5-utils/src/mix';import EmitterMixin from'@ckeditor/ckeditor5-utils/src/emittermixin';import _0x1b0595 from'./../messagescompressor';import AddCommentMessage from'./messages/addcommentmessage';import AddCommentResponse from'./responses/addcommentresponse';import ConnectMessage from'./messages/connectmessage';import ConnectResponse from'./responses/connectresponse';import RemoveCommentMessage from'./messages/removecommentmessage';import RemoveCommentThreadMessage from'./messages/removecommentthreadmessage';import UpdateCommentMessage from'./messages/updatecommentmessage';import GetCommentThreadMessage from'./messages/getcommentthreadmessage';import GetCommentThreadResponse from'./responses/getcommentthreadresponse';import GetDocumentThreadsMessage from'./messages/getdocumentthreadsmessage';import GetDocumentThreadsResponse from'./responses/getdocumentthreadsresponse';import WebSocketGateway from'./../websocketgateway/websocketgateway';import CKEditorCloudServicesError from'./../ckeditorcloudserviceserror';import _0x5567dc from'../sessions/sessions';export const _SERVICE=0x9;class CommentsService{constructor(documentId){this['_wsGateway']=null,this['_isConnected']=!0x1,this['_documentId']=documentId;}async['connect'](wsGateway){if(this['_isConnected'])return Promise['resolve']();if(wsGateway['state']!==WebSocketGateway['STATE_CONNECTED'])throw new CKEditorCloudServicesError('Web\x20socket\x20gateway\x20is\x20not\x20connected.',wsGateway);const connectMessage=new ConnectMessage(this['_documentId']);this['_wsGateway']=wsGateway,this['stopListening'](wsGateway,'change:state');const _0xce646e=await wsGateway['_sendRequest'](0x9,connectMessage['constructor']['TYPE'],_0x1b0595['encode'](connectMessage)),{channel:_0x236121,threads:threads}=_0x1b0595['decode'](_0xce646e,ConnectResponse);return this['listenTo'](wsGateway,'change:state',(..._0x176b6d)=>this['_onWsGatewayStateChange'](..._0x176b6d),{'priority':WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](wsGateway,_0x236121),this['_isConnected']=!0x0,this['fire']('connected'),threads;}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['addComment'](commentThreadId,commentId,content){const _0xb32b44=new AddCommentMessage(this['_documentId'],commentThreadId,content,commentId),_0x5d1809=await this['_wsGateway']['_sendRequest'](0x9,AddCommentMessage['TYPE'],_0x1b0595['encode'](_0xb32b44));return _0x1b0595['decode'](_0x5d1809,AddCommentResponse);}['updateComment'](commentThreadId,commentId,content){const _0x1ab0d9=new UpdateCommentMessage(this['_documentId'],commentThreadId,commentId,content);return this['_wsGateway']['_sendRequest'](0x9,UpdateCommentMessage['TYPE'],_0x1b0595['encode'](_0x1ab0d9));}['removeComment'](commentThreadId,commentId){const _0x2d3e42=new RemoveCommentMessage(this['_documentId'],commentThreadId,commentId);return this['_wsGateway']['_sendRequest'](0x9,RemoveCommentMessage['TYPE'],_0x1b0595['encode'](_0x2d3e42));}['removeCommentThread'](commentThreadId){const _0x184ab9=new RemoveCommentThreadMessage(this['_documentId'],commentThreadId);return this['_wsGateway']['_sendRequest'](0x9,RemoveCommentThreadMessage['TYPE'],_0x1b0595['encode'](_0x184ab9));}async['getCommentThread'](commentThreadId,attempt=0x1){const _0x54e5f2=new GetCommentThreadMessage(commentThreadId,this['_documentId']);try{const _0x23a88b=await this['_wsGateway']['_sendRequest'](0x9,GetCommentThreadMessage['TYPE'],_0x1b0595['encode'](_0x54e5f2));return _0x1b0595['decode'](_0x23a88b,GetCommentThreadResponse);}catch(_0x335818){if(_0x335818 instanceof CKEditorCloudServicesError&&'404'===_0x335818['code']&&attempt<0x5)return await(time=0x64*attempt,new Promise(_0x4128db=>{setTimeout(_0x4128db,time);})),await this['getCommentThread'](commentThreadId,attempt+0x1);if(_0x335818 instanceof CKEditorCloudServicesError)throw _0x335818;throw new CKEditorCloudServicesError(_0x335818['message'],this['_wsGateway']);}var time;}async['getDocumentThreads'](){const _0x217707=new GetDocumentThreadsMessage(this['_documentId']),_0x292a2a=await this['_wsGateway']['_sendRequest'](0x9,GetDocumentThreadsMessage['TYPE'],_0x1b0595['encode'](_0x217707));return _0x1b0595['decode'](_0x292a2a,GetDocumentThreadsResponse);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new CKEditorCloudServicesError('Comments\x20Service\x20is\x20not\x20connected.',this);return this['_connectedSessions']||(this['_connectedSessions']=await _0x5567dc['getConnectedSessions'](this['_wsGateway'],this['_documentId'],0x9)),this['_connectedSessions'];}['_connectToChannel'](wsGateway,_0x26edc3){this['_channel']=wsGateway['_getChannel'](CommentsService['_SERVICE'],_0x26edc3),this['listenTo'](this['_channel'],this['_channel']['getEventName'](AddCommentMessage['TYPE']),(event,data)=>{const addCommentMessage=_0x1b0595['decode'](data,AddCommentMessage);this['fire']('commentAdded',addCommentMessage);}),this['listenTo'](this['_channel'],this['_channel']['getEventName'](RemoveCommentMessage['TYPE']),(event,data)=>{const removeCommentMessage=_0x1b0595['decode'](data,RemoveCommentMessage);this['fire']('commentRemoved',removeCommentMessage);}),this['listenTo'](this['_channel'],this['_channel']['getEventName'](UpdateCommentMessage['TYPE']),(event,data)=>{const updateCommentMessage=_0x1b0595['decode'](data,UpdateCommentMessage);this['fire']('commentUpdated',updateCommentMessage);}),this['listenTo'](this['_channel'],this['_channel']['getEventName'](RemoveCommentThreadMessage['TYPE']),(event,data)=>{const removeCommentThreadMessage=_0x1b0595['decode'](data,RemoveCommentThreadMessage);this['fire']('commentThreadRemoved',removeCommentThreadMessage);});}['_onWsGatewayStateChange'](event,property,_0x5fc22c){_0x5fc22c===WebSocketGateway['STATE_DISCONNECTED']&&this['disconnect']();}static get['_SERVICE'](){return 0x9;}get['isConnected'](){return this['_isConnected'];}}_0x2e19bb(CommentsService,EmitterMixin);export default CommentsService;