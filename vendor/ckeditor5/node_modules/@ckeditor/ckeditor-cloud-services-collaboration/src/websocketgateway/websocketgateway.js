/*
 *             Copyright (c) 2016 - 2020, CKSource - Frederico Knabben. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import _0x5b2033 from'socket.io-client';import _0x2fc129 from'url-parse';import _0x2d2825 from'@ckeditor/ckeditor5-utils/src/mix';import priorities from'@ckeditor/ckeditor5-utils/src/priorities';import _0x20b583 from'@ckeditor/ckeditor5-utils/src/observablemixin';import{get}from'lodash-es';import _0x2c68c9 from'./channel';import _0x3011e5 from'./../users/user';import _0x11ba3d from'./../version';import CKEditorCloudServicesError from'./../ckeditorcloudserviceserror';import*as _0x416db7 from'./parser/parser';class WebSocketGateway{constructor(_0x51c27b,token,options={},connectionProvider=_0x5b2033,userFactory=_0x3011e5['get']){if(!_0x51c27b)throw new TypeError('Api\x20address\x20must\x20be\x20provided.');if(!token)throw new TypeError('Token\x20must\x20be\x20provided.');this['_url']=_0x2fc129(_0x51c27b['replace'](/^(?!(?:\w+:)?\/\/)/,'https://')),this['_token']=token,this['_connectionProvider']=connectionProvider,this['_userFactory']=userFactory,this['_options']=options,this['_channels']=new Map(),this['set']('state','disconnected'),this['set']('sessionId',void 0x0),this['set']('me',void 0x0),this['on']('change:state',async(event,_0x7d23f2,_0x141015)=>{if(_0x141015===WebSocketGateway['STATE_CONNECTED'])try{this['me']=await this['_userFactory']['call'](_0x3011e5,this,this['_socket']['auth']['userId']);}catch(_0x3f8b01){}},{'priority':WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']}),this['on']('error',(event,_0x4dcae2)=>{this['_options']['onError']?this['_options']['onError'](_0x4dcae2):console['log'](_0x4dcae2);});}['disconnect'](){this['state']===WebSocketGateway['STATE_CONNECTED']&&(this['_socket']['disconnect'](),this['_socket']=void 0x0,this['state']=WebSocketGateway['STATE_DISCONNECTED']);}['reconnect'](){return this['_token']['refreshToken'](),this['state']===WebSocketGateway['STATE_DISCONNECTED']?this['_connect']():Promise['resolve']();}['_sendRequest'](_0x3d4eb0,method,_0x38e40c){if(!_0x3d4eb0)return Promise['reject'](new CKEditorCloudServicesError('`serviceName`\x20must\x20be\x20provided.',this));if(this['state']!==WebSocketGateway['STATE_CONNECTED'])return Promise['reject'](new CKEditorCloudServicesError('Not\x20connected.',this));if(!this['_socket']||!this['_socket']['isAuthenticated'])return Promise['reject'](new CKEditorCloudServicesError('Not\x20authenticated.',this));const _0x2cace1=new ArrayBuffer(_0x38e40c['length']+0x2),_0x73b16d=new Uint8Array(_0x2cace1);return _0x73b16d[0x0]=_0x3d4eb0,_0x73b16d[0x1]=method,_0x73b16d['set'](_0x38e40c,0x2),this['_emit'](0x1,_0x73b16d);}['_getChannel'](_0x430f14,_0x55abfe){const _0x2a72d9=''+_0x430f14+_0x55abfe;return this['_channels']['has'](_0x2a72d9)||this['_channels']['set'](_0x2a72d9,new _0x2c68c9(_0x2a72d9,this,this['_socket'])),this['_channels']['get'](_0x2a72d9);}['_connect'](){return new Promise((_0x443e96,reject)=>{const socket=this['_setupSocket']();socket['once']('connect',async()=>{try{await this['_onConnect'](),_0x443e96();}catch(_0x46f5e6){reject(_0x46f5e6);}}),socket['connect']();});}['_setupSocket'](){if(this['_socket'])return this['_socket'];const port=this['_url']['port']||('http:'===this['_url']['protocol']?0x50:0x1bb),_0x1bd503=(this['_url']['protocol']||'https:')+'//'+this['_url']['hostname']+':'+port,socket=this['_connectionProvider'](_0x1bd503,{'parser':_0x416db7,'path':'/ws-v2/ws','transports':['websocket'],'timeout':0x1388,'reconnection':get(this['_options'],'autoReconnect',!0x0),'reconnectionDelay':0x3e8,'reconnectionDelayMax':0x1388,'rejectUnauthorized':get(this['_options'],'rejectUnauthorized',!0x0),'query':{'version':_0x11ba3d}});return this['state']=WebSocketGateway['STATE_CONNECTING'],socket['on']('connect',()=>{this['sessionId']=socket['id'];}),socket['on']('reconnect',this['_onConnect']['bind'](this)),socket['on']('disconnect',this['_onDisconnect']['bind'](this)),socket['on']('error',this['_onError']['bind'](this)),socket['on']('unauthorized',this['_onUnauthorized']['bind'](this)),this['_socket']=socket,socket;}['_emit'](eventName,_0x400f24){const socket=this['_socket'];return new Promise((_0x4a4551,reject)=>{socket['emit'](eventName,_0x400f24,(_0x5171ad,_0x3a82c5)=>{_0x5171ad&&reject(CKEditorCloudServicesError['fromPublicError'](_0x5171ad,this)),_0x4a4551(_0x3a82c5);});});}['_addAuthData'](environmentId,_0x1dee5b){this['_socket']['auth']={'environmentId':environmentId,'userId':_0x1dee5b},this['_socket']['isAuthenticated']=!0x0;}['_removeAuthData'](){this['_socket']['isAuthenticated']=!0x1,delete this['_socket']['auth'];}async['_onConnect'](){await this['_authenticate'](this['_token']['value']),this['state']=WebSocketGateway['STATE_CONNECTED'],this['_token']['on']('change:value',this['_onTokenChange']['bind'](this)),this['on']('disconnect',()=>{this['_token']['off']('change:value',this['_onTokenChange']['bind'](this));});}async['_onTokenChange'](event,_0x4a2c16,_0x34e80a){try{await this['_authenticate'](_0x34e80a);}catch(_0x3c36c8){}}['_onDisconnect'](){this['state']=WebSocketGateway['STATE_DISCONNECTED'],this['fire']('disconnect');for(const _0x233dc7 of this['_channels']['values']())_0x233dc7['remove']();this['_channels']['clear']();}['_onError'](_0x27fbae){this['fire']('error',new CKEditorCloudServicesError(_0x27fbae['message'],this,_0x27fbae['code']));}['_onUnauthorized']({error:_0x354e93}){this['_removeAuthData'](),this['fire']('error',CKEditorCloudServicesError['fromPublicError'](_0x354e93,this));}async['_authenticate'](token){try{const _0x3be66e=await this['_emit'](0x2,{'token':token});this['_addAuthData'](_0x3be66e['environmentId'],_0x3be66e['userId']);}catch(_0x10c82c){throw this['_removeAuthData'](),_0x10c82c;}}static get['STATE_DISCONNECTED'](){return'disconnected';}static get['STATE_CONNECTING'](){return'connecting';}static get['STATE_CONNECTED'](){return'connected';}static get['_CHANGE_STATE_EVENT_PRIORITY'](){return priorities['get']('highest')+0xf423f;}static async['connect'](token,_0x50d45f=WEB_SOCKET_GATEWAY_URL,options={},_0x215831,userFactory=_0x3011e5['get']){const webSocketGateway=new WebSocketGateway(_0x50d45f,token,options,_0x215831,userFactory);return await webSocketGateway['_connect'](),webSocketGateway;}}_0x2d2825(WebSocketGateway,_0x20b583);export default WebSocketGateway;