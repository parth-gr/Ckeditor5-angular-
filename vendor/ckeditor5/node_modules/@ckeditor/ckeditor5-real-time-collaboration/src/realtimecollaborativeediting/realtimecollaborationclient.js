/*
 *             Copyright (c) 2016 - 2020, CKSource - Frederico Knabben. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import _0x433e74 from'@ckeditor/ckeditor5-core/src/plugin';import _0x4a441a from'./websocketgateway';import _0x485c1a from'./sessions';import _0x57842e from'./usermarkers';import _0x26ce91 from'@ckeditor/ckeditor5-core/src/pendingactions';import _0x5daa35 from'@ckeditor/ckeditor5-collaboration-core/src/users';import _0x2c783a from'@ckeditor/ckeditor5-operations-compressor/src/compressor';import _0x5a50cc from'@ckeditor/ckeditor5-utils/src/ckeditorerror';import _0x4f380d from'@ckeditor/ckeditor-cloud-services-collaboration/src/collaborativeeditingservice/collaborativeeditingservice';import{transformSets as _0x5506bf}from'@ckeditor/ckeditor5-engine/src/model/operation/transform';import _0x2e6793 from'@ckeditor/ckeditor5-engine/src/model/operation/insertoperation';import _0x2061a0 from'@ckeditor/ckeditor5-engine/src/model/operation/markeroperation';import _0x52e0ef from'@ckeditor/ckeditor5-engine/src/model/operation/operationfactory';import{version as _0x3c41d3}from'@ckeditor/ckeditor5-engine/package.json';let J=0x1;export default class E extends _0x433e74{static get['requires'](){return[_0x4a441a,_0x485c1a,_0x57842e,_0x26ce91,_0x5daa35];}static get['pluginName'](){return'RealTimeCollaborationClient';}get['cloudDocumentVersion'](){return this['lastSyncVersion']+this['offset'];}['init'](){const _0x175c97=this['editor'],_0x2efb0e=_0x175c97['plugins']['get'](_0x5daa35),_0x3b52e5=_0x175c97['plugins']['get'](_0x4a441a);if(this['channelId']=_0x175c97['config']['get']('collaboration.channelId'),!this['channelId'])throw new _0x5a50cc('collaboration-missing-channelId:\x20Unique\x20`collaboration.channelId`\x20configuration\x20is\x20required\x20for\x20defining\x20name\x20for\x20data\x20stores.\x20Note\x20that\x20application\x20instances\x20with\x20the\x20same\x20channelId\x20will\x20share\x20data\x20each\x20other.',this);this['listenTo'](_0x2efb0e,'getOperationAuthor',(_0x4c4603,_0x2c8ec1)=>{const _0x22c77c=_0x2c8ec1[0x0];_0x22c77c['_authorId']&&(_0x4c4603['return']=_0x2efb0e['getUser'](_0x22c77c['_authorId']),_0x4c4603['stop']()),null===_0x22c77c['_authorId']&&(_0x4c4603['return']=null,_0x4c4603['stop']());},{'priority':'high'});const _0x3a123a=_0x175c97['config']['get']('cloudServices.bundleVersion')||_0x3c41d3;this['service']=new E['CollaborativeEditingService'](_0x3a123a,this['channelId']),this['lastSyncVersion']=0x0,this['offset']=0x0,this['p']=this['editor']['model']['document'],this['u']=new _0x2c783a(),this['_bufferedOperations']=new Set(),this['g']=new WeakSet(),this['set']('_isPendingUpdate',!0x1),this['k']=null,this['_']=!0x1,this['O']=null,this['listenTo'](_0x175c97['model']['document']['selection'],'change:range',(_0x180700,_0x3d15a0)=>{_0x3d15a0['directChange']&&this['v']();}),this['listenTo'](_0x175c97['editing']['view'],'change:hasDomSelection',()=>{this['v']();}),E['CollaborativeEditingService']['getConnectedSessions'](_0x3b52e5['connection'],this['channelId'])['then'](_0x6ea6cb=>this['S'](_0x6ea6cb))['catch'](_0x43e217=>{this['A']('realtimecollaborationclient-init-session-connection-error',_0x43e217);}),this['D'](),this['I'](),_0x175c97['plugins']['get'](_0x4a441a)['addToReconnectionStack'](this),_0x175c97['model']['on']('applyOperation',(_0x4b2429,_0x5b8f00)=>{const _0x2157e0=_0x5b8f00[0x0];_0x2157e0['isDocumentOperation']&&(this['T'](_0x2157e0),this['N']()&&this['_sendBufferedOperationsDelayed']());}),this['C'](),this['editor']['bind']('isReadOnly')['to'](_0x3b52e5,'state',_0x55b864=>'connected'!==_0x55b864);}async['reconnect'](){const _0x3cb913=this['editor']['plugins']['get'](_0x485c1a),_0x3a20e6=this['editor']['plugins']['get'](_0x4a441a);_0x3cb913['unregister'](this['channelId']);const _0x394b46=await this['service']['reconnect'](_0x3a20e6['connection'],this['lastSyncVersion']);this['U']([],Object['assign']({},_0x394b46,{'data':_0x394b46['data'],'wereChangesApplied':!0x1}),'reconnect');const _0x2b3b03=await E['CollaborativeEditingService']['getConnectedSessions'](_0x3a20e6['connection'],this['channelId']);_0x3cb913['register'](this['channelId'],_0x2b3b03),this['_isPendingUpdate']=!0x1;}['destroy'](){const _0x3da16b=this['editor']['plugins']['get'](_0x4a441a),_0x53c85c=this['editor']['plugins']['get'](_0x485c1a);this['editor']['isReadOnly']=!0x0,_0x53c85c['channelSessions']['has'](this['channelId'])&&_0x53c85c['unregister'](this['channelId']),super['destroy'](),_0x3da16b['removeFromReconnectionStack'](this),clearTimeout(this['O']);}['S'](_0x40fcd0){const _0x3451b8=this['editor'],_0xedd85e=_0x3451b8['plugins']['get'](_0x485c1a);this['listenTo'](_0xedd85e,'sessionAdd:'+this['channelId'],(_0x59bd9b,{session:_0xcce53d})=>{_0xcce53d['id']===_0xedd85e['mySessionId']&&(_0x59bd9b['off'](),'reader'===_0xcce53d['role']?_0x3451b8['isReadOnly']=!0x0:'commentator'===_0xcce53d['role']&&_0x3451b8['plugins']['has']('CommentsOnly')&&(_0x3451b8['plugins']['get']('CommentsOnly')['isEnabled']=!0x0));}),_0xedd85e['register'](this['channelId'],_0x40fcd0);}['D'](){const _0x59774f=this['editor']['data']['set'];this['editor']['data']['set']=(..._0x4c5b30)=>{if(!_0x4c5b30[_0x4c5b30['length']-0x1]['suppressErrorInCollaboration'])throw new _0x5a50cc('realtimecollaborationclient-editor-setdata-and-editor-data-set-are-forbidden-in-real-time-collaboration:Trying\x20to\x20use\x20`editor.setData()`\x20or\x20`editor.data.set()`\x20in\x20real-time\x20collaboration.',this);_0x59774f['apply'](this['editor']['data'],_0x4c5b30);};}['I'](){this['listenTo'](this['service'],'operationsReceived',(_0x453ca4,_0x24152b,_0x50ee5a,_0x33dd4a)=>{if(!this['_isPendingUpdate']&&this['p']['version']==_0x24152b){const _0x4c4b7d=this['P'](_0x50ee5a);this['R'](_0x4c4b7d,_0x33dd4a),this['lastSyncVersion']=_0x24152b+_0x4c4b7d['length'],this['B'](_0x4c4b7d)||this['A']('realtimecollaborationclient-initservice-incorrect-server-operation');}}),this['listenTo'](this['service'],'error',(_0x137009,_0xafd443)=>{this['A']('realtimecollaborationclient-initservice-internal-error',_0xafd443);});}['C'](){const {connection:_0x1d36eb}=this['editor']['plugins']['get'](_0x4a441a);this['editor']['data']['on']('init',(_0x4be782,[_0x316faa])=>{if(this['p']['version'])throw new _0x5a50cc('realtimecollaborationclient-init-document-already-initialized:\x20Trying\x20to\x20set\x20initial\x20data\x20to\x20initialized\x20document.',this);_0x4be782['stop']();const _0x5c8280=this['j'](_0x316faa);this['q'](),_0x4be782['return']=this['service']['connect'](_0x1d36eb,this['G'](_0x5c8280))['then'](_0x51fa5e=>{this['V'](),this['W'](_0x51fa5e,_0x5c8280);const _0x5e0e4f=this['editor']['plugins']['get'](_0x485c1a),_0x47a51c=_0x5e0e4f['channelSessions']['get'](this['channelId']);_0x47a51c&&_0x47a51c['length']>0x1?(this['_']=!0x0,this['_sendBufferedOperationsDelayed']()):_0x5e0e4f['on']('sessionAdd:'+this['channelId'],_0x449e2c=>{_0x5e0e4f['channelSessions']['get'](this['channelId'])['length']>0x1&&(this['_']=!0x0,this['_sendBufferedOperationsDelayed'](),_0x449e2c['off']());}),this['editor']['data']['fire']('ready');})['catch'](_0x464934=>this['A']('realtimecollaborationclient-init-connection-failed',_0x464934));},{'priority':'high'});}['j'](_0x3209f2){const _0x59b2cb=this['editor']['model'],_0x1812c3=[];let _0x2007fd=0x0;const _0x473d15='string'==typeof _0x3209f2?{'main':_0x3209f2}:_0x3209f2;for(const _0x2b2314 of Object['keys'](_0x473d15)){if(!this['p']['roots']['has'](_0x2b2314))throw new _0x5a50cc('realtimecollaborationclient-init-non-existent-root:\x20Attempting\x20to\x20init\x20data\x20on\x20a\x20non-existing\x20root.',this);const _0x254d51=this['editor']['data']['parse'](_0x473d15[_0x2b2314]),_0x6ac9aa=this['p']['getRoot'](_0x2b2314),_0x130237=new _0x2e6793(_0x59b2cb['createPositionAt'](_0x6ac9aa,0x0),_0x254d51,_0x2007fd++);_0x1812c3['push'](_0x130237);for(const [_0x15089f,_0x3c7eef]of _0x254d51['markers']){const _0x2bf815=_0x59b2cb['createRange'](_0x59b2cb['createPositionFromPath'](_0x6ac9aa,_0x3c7eef['start']['path']['slice']()),_0x59b2cb['createPositionFromPath'](_0x6ac9aa,_0x3c7eef['end']['path']['slice']())),_0xa69ede=new _0x2061a0(_0x15089f,null,_0x2bf815,_0x59b2cb['markers'],!0x0,_0x2007fd++);_0x1812c3['push'](_0xa69ede);}}return _0x1812c3;}['W'](_0x1439b6,_0x43955e){let _0x349340;this['offset']=_0x1439b6['offset'];const _0x34bc34=_0x1439b6['wereChangesApplied'];_0x34bc34?_0x349340=_0x43955e:(this['p']['version']=_0x1439b6['data']['baseVersion'],_0x349340=this['P'](_0x1439b6['data']),this['R'](_0x349340,_0x1439b6['metadata'])),this['lastSyncVersion']=_0x1439b6['version'],this['F'](_0x349340,_0x34bc34);}['A'](_0x2b9cbd,_0x342903){throw this['_isPendingUpdate']=!0x0,_0x342903&&console['error'](_0x342903),new _0x5a50cc(_0x2b9cbd,this['editor']);}['T'](_0x39deab){this['g']['has'](_0x39deab)||(this['g']['add'](_0x39deab),this['_bufferedOperations']['add'](_0x39deab),this['k']||'marker'==_0x39deab['type']&&!_0x39deab['affectsData']||this['q']());}['v'](){this['_']=!0x0,this['H']()&&this['_sendBufferedOperationsDelayed']();}['H'](){const _0x71c43b=this['editor']['plugins']['get'](_0x485c1a)['channelSessions']['get'](this['channelId']);return!this['editor']['isReadOnly']&&_0x71c43b&&_0x71c43b['length']>0x1&&this['_'];}['N'](){return this['_bufferedOperations']['size']>0x0||this['H']();}async['M'](){const _0xaf280e=this['editor']['plugins']['get'](_0x57842e);if(this['H']()&&(_0xaf280e['createUserMarkerOperations'](),this['_']=!0x1),!this['N']())return Promise['resolve'](!0x0);const _0x4998fe=Array['from'](this['_bufferedOperations']);for(const _0x46c406 of _0x4998fe)_0x46c406['wasUndone']=this['p']['history']['isUndoneOperation'](_0x46c406);const _0x559ca4=J++,_0x3f505e=await this['service']['sendOperations'](this['G'](_0x4998fe),this['lastSyncVersion']);try{return this['U'](_0x4998fe,_0x3f505e,_0x559ca4);}catch(_0x2e1a94){return this['A']('realtimecollaborationclient-sendbufferedoperations',_0x2e1a94);}}['_sendBufferedOperationsDelayed'](_0x2aac14=!0x1){!_0x2aac14&&this['_isPendingUpdate']||(this['_isPendingUpdate']=!0x0,clearTimeout(this['O']),this['O']=setTimeout(()=>{this['M']()['then'](_0x322a5c=>{_0x322a5c&&(this['V'](),this['_isPendingUpdate']=!0x1);})['catch'](_0x5dcdf0=>{throw this['V'](),this['_isPendingUpdate']=!0x1,_0x5dcdf0;});},0x12c));}['U'](_0x153743,_0x362c7f,_0x119257){if(_0x362c7f['error'])throw _0x362c7f['error'];let _0x2d02fd=!0x1;if(_0x362c7f['wereChangesApplied']){for(const _0x2f223d of _0x153743)this['_bufferedOperations']['delete'](_0x2f223d),delete _0x2f223d['wasUndone'];_0x2d02fd=!0x0;}else{const _0x24f094=this['P'](_0x362c7f['data']);this['R'](_0x24f094,_0x362c7f['metadata']),_0x2d02fd=this['B'](_0x24f094,_0x362c7f['version']);}return _0x2d02fd?(this['lastSyncVersion']=_0x362c7f['version'],!this['N']()||(this['_sendBufferedOperationsDelayed'](!0x0),!0x1)):this['A']('realtimecollaborationclient-handleserverresponse');}['B'](_0x1811df,_0x4cf0aa){try{const _0x66a47a=Array['from'](this['_bufferedOperations']),_0x2783a6={'document':this['p'],'useRelations':!0x1,'padWithNoOps':!0x0},{operationsA:_0x596ea2,operationsB:_0x3d04fb,originalOperations:_0x3c417f}=_0x5506bf(_0x1811df,_0x66a47a,_0x2783a6);K(_0x596ea2,this['p']['version']),K(_0x3d04fb,_0x4cf0aa);for(const _0x2ab530 of _0x596ea2){const _0x4064fc=_0x3c417f['get'](_0x2ab530);_0x2ab530['_authorId']=_0x4064fc?_0x4064fc['_authorId']:null;}this['_bufferedOperations']=new Set(_0x3d04fb),this['F'](_0x596ea2);}catch(_0x4c07c0){return console['error'](_0x4c07c0),!0x1;}return!0x0;}['F'](_0x1830fc,_0x41ffd4=!0x1){this['editor']['model']['enqueueChange']('transparent',_0x227d9d=>{for(const _0xd40d81 of _0x1830fc)this['g']['add'](_0xd40d81),_0x227d9d['batch']['addOperation'](_0xd40d81),this['editor']['model']['applyOperation'](_0xd40d81);});}['q'](){const {t:t}=this['editor']['locale'];this['k']=this['editor']['plugins']['get'](_0x26ce91)['add'](t({'string':'Sending\x20data\x20to\x20the\x20server.','id':'PENDING_ACTION_SENDING_DATA'}));}['V'](){this['k']&&(this['editor']['plugins']['get'](_0x26ce91)['remove'](this['k']),this['k']=null);}['G'](_0x44cdfc){return this['u']['compress'](_0x44cdfc['map'](_0x185dfd=>_0x185dfd['toJSON']()));}['P'](_0x5a076a){return this['u']['decompress'](_0x5a076a)['map'](_0x6a7b17=>{const _0x5bc468=_0x52e0ef['fromJSON'](_0x6a7b17,this['p']);return _0x5bc468['wasUndone']=_0x6a7b17['wasUndone'],_0x5bc468;});}['R'](_0x211fa4,_0x5462c7){for(let _0x3babe3=0x0;_0x3babe3<_0x211fa4['length'];_0x3babe3++)'init'!=_0x5462c7[_0x3babe3]['type']?_0x211fa4[_0x3babe3]['_authorId']=_0x5462c7[_0x3babe3]['userId']:_0x211fa4[_0x3babe3]['_authorId']=null;}}function K(_0x3d1330,_0xc632c){for(const _0x56b93a of _0x3d1330)_0x56b93a['baseVersion']=_0xc632c++;}E['CollaborativeEditingService']=_0x4f380d;