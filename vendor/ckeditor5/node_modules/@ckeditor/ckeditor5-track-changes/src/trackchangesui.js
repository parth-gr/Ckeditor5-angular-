/*
 *             Copyright (c) 2016 - 2020, CKSource - Frederico Knabben. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import _0x3239c3 from'@ckeditor/ckeditor5-core/src/plugin';import gt from'./trackchangesediting';import St from'@ckeditor/ckeditor5-comments/src/comments/commentsrepository';import Tt from'./ui/suggestioncontroller';import xt from'./ui/view/suggestionthreadview';import lt from'@ckeditor/ckeditor5-collaboration-core/src/users';import Et from'@ckeditor/ckeditor5-comments/src/annotations/annotations';import Nt from'@ckeditor/ckeditor5-comments/src/annotations/editorannotations';import Ut from'@ckeditor/ckeditor5-ui/src/model';import Wt from'@ckeditor/ckeditor5-utils/src/collection';import Ot from'@ckeditor/ckeditor5-ui/src/dropdown/button/splitbuttonview';import{createDropdown as Gt,addListToDropdown as Mt}from'@ckeditor/ckeditor5-ui/src/dropdown/utils';import Vt from'@ckeditor/ckeditor5-comments/src/utils/getdatetimeformatter';import Pt from'@ckeditor/ckeditor5-comments/src/utils/getmarkerdomelement';import qt from'../theme/icons/track-changes.svg';import{debounce as zt}from'lodash-es';export default class dt extends _0x3239c3{static get['requires'](){return[Et,Nt,gt,St,lt];}static get['pluginName'](){return'TrackChangesUI';}constructor(_0x567e59){super(_0x567e59),this['_suggestionToController']=new Map(),this['_viewToController']=new Map(),this['st']=new Map(),this['editor']['config']['define']('trackChanges.SuggestionThreadView',xt);}['init'](){const _0x1a5845=this['editor'],_0x18d5a9=_0x1a5845['plugins']['get']('TrackChangesEditing'),_0x3d6c09=_0x1a5845['plugins']['get']('Annotations'),_0x26ec9e=_0x1a5845['plugins']['get']('EditorAnnotations'),_0x2336fb=_0x1a5845['plugins']['get']('CommentsRepository');_0x1a5845['ui']['componentFactory']['add']('trackChanges',_0x5c384a=>this['ot'](_0x5c384a)),_0x26ec9e['addSourceCollector'](()=>{const _0x439e7a=[];for(const [_0x1a4980,_0x216f8b]of Array['from'](this['_suggestionToController'])){const _0x5ac123=_0x1a4980['getAllAdjacentSuggestions'](),_0x518dd4=[];for(const _0x36cc40 of _0x5ac123){const _0x1681e5=_0x36cc40['getRanges']();for(let _0x555cf0=0x0;_0x555cf0<_0x1681e5['length'];_0x555cf0++)0x0==_0x555cf0&&_0x518dd4['length']>0x0?_0x518dd4[0x0]['end']=_0x1681e5[0x0]['end']['clone']():_0x518dd4['push'](_0x1681e5[_0x555cf0]);}_0x439e7a['push']([_0x216f8b['view'],_0x518dd4]);}return _0x439e7a;}),this['listenTo'](_0x18d5a9,'suggestionLoaded',(_0xe77e56,_0xc78dc)=>{let _0x55cbc9=!0x1;const _0x2c75fb=zt(_0x4cd6f4=>{_0x55cbc9||_0x4cd6f4?_0x55cbc9&&_0x4cd6f4&&(this['nt'](_0xc78dc),_0x26ec9e['refreshSelectedViews'](),_0x55cbc9=!0x1):(this['rt'](_0xc78dc),_0x26ec9e['refreshSelectedViews'](),_0x55cbc9=!0x0);},0xa);this['st']['set'](_0xc78dc,_0x2c75fb),this['listenTo'](_0xc78dc,'change:previous',(_0x115582,_0x45ffe1,_0xd97eef,_0x2684c6)=>{_0xc78dc['isInContent']&&(null==_0xd97eef?(this['ct'](_0x2684c6['head']),_0x2c75fb(!0x1)):(this['ct'](_0xd97eef['head']),_0x2c75fb(!0x0)));}),null===_0xc78dc['previous']?_0x2c75fb(!0x1):this['ct'](_0xc78dc['head']);}),this['listenTo'](_0x18d5a9,'suggestionUnloaded',(_0x2abd97,_0x308fc6,_0x4de586)=>{this['stopListening'](_0x308fc6,'change:previous'),this['st']['get'](_0x308fc6)['cancel'](),this['st']['delete'](_0x308fc6);const _0x7f8904=_0x4de586?_0x4de586['head']:_0x308fc6,_0x3793d5=this['_suggestionToController']['get'](_0x7f8904);null!==_0x4de586&&this['ct'](_0x7f8904),null===_0x4de586&&_0x3793d5&&this['nt'](_0x308fc6);}),this['listenTo'](_0x18d5a9,'suggestionChanged',(_0x122995,_0x317409)=>{this['ct'](_0x317409);}),this['listenTo'](_0x3d6c09,'change:activeView',(_0x520c9b,_0x86cd2b,_0x253f4f,_0x220617)=>{if(_0x220617&&this['_viewToController']['has'](_0x220617)&&(_0x220617['isActive']=!0x1),_0x253f4f&&this['_viewToController']['has'](_0x253f4f)){const _0x151234=this['_viewToController']['get'](_0x253f4f)['model']['getAllAdjacentSuggestions']();_0x253f4f['isActive']=!0x0,_0x18d5a9['activeMarkers']=_0x151234['reduce']((_0x11506a,_0x56bd5b)=>[..._0x11506a,..._0x56bd5b['getMarkerNames']()],[]);}else _0x18d5a9['activeMarkers']=[];}),this['listenTo'](_0x2336fb,'addComment',(_0x3789a4,{threadId:_0x53b63,isFromAdapter:_0x3a482f})=>{if(_0x3a482f||!_0x18d5a9['hasSuggestion'](_0x53b63))return;const _0x32e5eb=_0x18d5a9['getSuggestion'](_0x53b63);this['_suggestionToController']['get'](_0x32e5eb)['view']['focus']();},{'priority':'lowest'});}['ot'](_0x29c4f7){const _0x185cdc=Gt(_0x29c4f7,Ot),_0x5ad54f=this['editor']['commands']['get']('trackChanges'),{t:t}=this['editor'];_0x185cdc['buttonView']['set']({'tooltip':t('Track\x20changes'),'label':t('Track\x20changes'),'icon':qt}),_0x185cdc['buttonView']['bind']('isOn')['to'](_0x5ad54f,'value'),_0x185cdc['buttonView']['on']('execute',()=>_0x5ad54f['execute']());const _0x5cfe3f=new Wt(),_0x4ae96b=[{'type':'switchbutton','model':{'withText':!0x0,'label':t('Track\x20changes'),'commandName':'trackChanges'}},{'type':'separator'},{'type':'button','model':{'withText':!0x0,'label':t('Accept\x20all\x20suggestions'),'commandName':'acceptAllSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Accept\x20all\x20selected\x20suggestions'),'commandName':'acceptSelectedSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Discard\x20all\x20suggestions'),'commandName':'discardAllSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Discard\x20all\x20selected\x20suggestions'),'commandName':'discardSelectedSuggestions'}}];for(const _0x461ac3 of _0x4ae96b){const _0x3f4c5a={'type':_0x461ac3['type']};if(_0x461ac3['model']){const _0xbff4c8=new Ut(_0x461ac3['model']),_0x10ca50=this['editor']['commands']['get'](_0xbff4c8['commandName']);_0xbff4c8['bind']('isOn','isEnabled')['to'](_0x10ca50,'value','isEnabled'),_0x3f4c5a['model']=_0xbff4c8;}_0x5cfe3f['add'](_0x3f4c5a);}Mt(_0x185cdc,_0x5cfe3f);const _0x36f2f9=_0x4ae96b['filter'](_0x52c25b=>null!=_0x52c25b['model'])['map'](_0x4d9c31=>this['editor']['commands']['get'](_0x4d9c31['model']['commandName']));return _0x185cdc['buttonView']['actionView']['unbind']('isEnabled'),_0x185cdc['buttonView']['arrowView']['unbind']('isEnabled'),_0x185cdc['buttonView']['actionView']['bind']('isEnabled')['to'](_0x5ad54f,'isEnabled'),_0x185cdc['buttonView']['arrowView']['bind']('isEnabled')['toMany'](_0x36f2f9,'isEnabled',(..._0x3e9ff4)=>_0x3e9ff4['some'](_0x2c58ac=>_0x2c58ac)),_0x185cdc['on']('execute',_0x166887=>this['editor']['execute'](_0x166887['source']['commandName'])),_0x185cdc;}['rt'](_0x568e04){const _0x3ad0ab=this['editor'],_0x496183=_0x3ad0ab['config'],_0x6c10b5=_0x3ad0ab['plugins']['get']('Annotations'),_0x5c9775=_0x568e04['getAllAdjacentSuggestions']()['filter'](_0x2fcdd2=>_0x2fcdd2['isInContent']),_0x2f9c31=_0x3ad0ab['plugins']['get']('Users')['me'],_0x4e8fea=_0x3ad0ab['commands']['get']('acceptSuggestion'),_0xce5fc8=_0x3ad0ab['commands']['get']('discardSuggestion'),_0x541275=new(0x0,(_0x496183['get']('trackChanges'))['SuggestionThreadView'])(_0x3ad0ab['locale'],_0x568e04,_0x2f9c31,{'editorConfig':_0x496183['get']('comments.editorConfig'),'maxCommentsWhenCollapsed':_0x496183['get']('comments.maxCommentsWhenCollapsed'),'maxThreadTotalWeight':_0x496183['get']('comments.maxThreadTotalWeight'),'maxCommentCharsWhenCollapsed':_0x496183['get']('comments.maxCommentCharsWhenCollapsed'),'formatDateTime':Vt(_0x496183['get']('locale')),'CommentView':_0x496183['get']('comments')['CommentView']}),_0x2351c6=new Tt(_0x568e04,_0x541275,_0x4e8fea,_0xce5fc8);_0x541275['descriptionParts']=_0x3ad0ab['plugins']['get']('TrackChangesEditing')['_descriptionFactory']['getDescriptions'](_0x5c9775),this['_suggestionToController']['set'](_0x568e04,_0x2351c6),this['_viewToController']['set'](_0x541275,_0x2351c6);const _0x10a0fd=_0x5c9775[0x0]['getFirstMarker'](),_0x4244d8=_0x6c10b5['add'](_0x541275,()=>Pt(_0x3ad0ab['editing'],_0x10a0fd));_0x4244d8['bind']('type')['to'](_0x2351c6['view'],'type',_0x181054=>'suggestion-'+_0x181054),_0x4244d8['bind']('hasChanges')['to'](_0x541275,'isDirty'),_0x4244d8['bind']('length')['to'](_0x541275);const _0x4dc959=_0x3ad0ab['plugins']['get']('PendingActions');let _0x19c694;_0x541275['on']('change:isDirty',(_0x35e06,_0x3db32d,_0x5659ea)=>{if(_0x5659ea){const t=this['editor']['locale']['t'];_0x19c694=_0x4dc959['add'](t({'string':'Unsaved\x20change\x20in\x20suggestion.','id':'PENDING_ACTION_SUGGESTION'}));}else _0x4dc959['remove'](_0x19c694),_0x19c694=null;});}['nt'](_0x233467){const _0x3042b6=this['editor']['plugins']['get']('Annotations'),_0x409da1=this['_suggestionToController']['get'](_0x233467),_0x40cd3d=_0x409da1['view'];_0x3042b6['remove'](_0x40cd3d),this['_suggestionToController']['delete'](_0x233467),this['_viewToController']['delete'](_0x40cd3d),_0x409da1['destroy'](),_0x40cd3d['destroy']();}['ct'](_0x4b8d45){if(!this['_suggestionToController']['has'](_0x4b8d45))return;const _0x288d15=this['editor']['plugins']['get']('TrackChangesEditing'),_0x56ff37=this['_suggestionToController']['get'](_0x4b8d45),_0x1cf315=_0x4b8d45['getAllAdjacentSuggestions']();_0x56ff37['view']['descriptionParts']=_0x288d15['_descriptionFactory']['getDescriptions'](_0x1cf315);}['destroy'](){super['destroy']();for(const _0x2ba4a1 of this['_suggestionToController']['keys']())this['nt'](_0x2ba4a1);for(const _0x2d828b of this['st']['values']())_0x2d828b['cancel']();this['st']['clear']();}}